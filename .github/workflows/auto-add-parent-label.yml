name: Auto add general area label

on:
  issues:
    types: [labeled]

permissions: {}

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.run_id }}"
  cancel-in-progress: true

jobs:
  add-general-label:
    name: "Add general label"
    runs-on: ubuntu-slim
    permissions:
      issues: write # needed to add issue label
    steps:
      - name: Add general area label
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const addedLabel = context.payload.label.name;
            const issue = context.payload.issue;

            // Explicit allowlist of supported parent labels
            const allowedParents = new Set([
              "area: compose",
              "area: left sidebar",
              // add more parent labels here if needed
            ]);

            // Match labels like: "area: compose (uploads)"
            const match = addedLabel.match(/^area:\s*([^(]+)\s*\(/);
            if (!match) return;

            const parentLabel = `area: ${match[1].trim()}`;

            // Skip if this parent label isnâ€™t explicitly supported
            if (!allowedParents.has(parentLabel)) return;

            // Avoid re-adding if parent already exists
            if (issue.labels.some(l => l.name === parentLabel)) return;

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: [parentLabel],
            });
